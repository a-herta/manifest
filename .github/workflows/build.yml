name: ğŸ—ï¸ Build & Release

on:
  push:
    branches: [ main ]
    paths: 
      - "src/**"
      - "main.py"
      - "requirements.txt"
      - "pyproject.toml"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - release

env:
  PYTHON_VERSION: "3.11"
  APP_NAME: "steam-manifest-tool"

jobs:
  # ğŸ—ï¸ æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
  build-executable:
    name: ğŸ—ï¸ Build Executable
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            extension: ""
            icon: ""
          - os: windows-latest
            platform: windows
            extension: ".exe"
            icon: "-i main.ico"
          - os: macos-latest
            platform: macos
            extension: ""
            icon: ""

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: ğŸ—ï¸ Build executable
        run: |
          pyinstaller --onefile \
            --name ${{ env.APP_NAME }}-${{ matrix.platform }} \
            ${{ matrix.icon }} \
            --distpath dist/${{ matrix.platform }} \
            --workpath build/${{ matrix.platform }} \
            --specpath build \
            main.py

      - name: ğŸ“¦ Package executable (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          cd dist/${{ matrix.platform }}
          tar -czf ${{ env.APP_NAME }}-${{ matrix.platform }}.tar.gz ${{ env.APP_NAME }}-${{ matrix.platform }}

      - name: ğŸ“¦ Package executable (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd dist/${{ matrix.platform }}
          7z a ${{ env.APP_NAME }}-${{ matrix.platform }}.zip ${{ env.APP_NAME }}-${{ matrix.platform }}.exe

      - name: ğŸ“Š Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: executable-${{ matrix.platform }}
          path: |
            dist/${{ matrix.platform }}/*.tar.gz
            dist/${{ matrix.platform }}/*.zip
            dist/${{ matrix.platform }}/${{ env.APP_NAME }}-${{ matrix.platform }}*

      - name: ğŸ§ª Test executable
        run: |
          cd dist/${{ matrix.platform }}
          ./${{ env.APP_NAME }}-${{ matrix.platform }}${{ matrix.extension }} --version

  # ğŸ“¦ æ„å»º Python åŒ…
  build-package:
    name: ğŸ“¦ Build Python Package
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine wheel

      - name: ğŸ—ï¸ Build package
        run: python -m build

      - name: ğŸ” Check package
        run: twine check dist/*

      - name: ğŸ“Š Upload package
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/

  # ğŸš€ å‘å¸ƒåˆ° GitHub Releases
  create-release:
    name: ğŸš€ Create Release
    needs: [build-executable, build-package]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ğŸ“‹ Display structure
        run: ls -la artifacts/

      - name: ğŸš€ Create Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'release'
        with:
          files: |
            artifacts/executable-*/*
            artifacts/python-package/*
          body: |
            ## ğŸ‰ Steam Manifest Tool Release
            
            ### ğŸ“¦ Downloads
            - **Windows**: `steam-manifest-tool-windows.zip`
            - **Linux**: `steam-manifest-tool-linux.tar.gz` 
            - **macOS**: `steam-manifest-tool-macos.tar.gz`
            - **Python Package**: `steam_manifest_tool-*.whl` / `steam-manifest-tool-*.tar.gz`
            
            ### ğŸš€ Installation
            ```bash
            # Install from PyPI (when published)
            pip install steam-manifest-tool
            
            # Or download and run executable directly
            ./steam-manifest-tool --help
            ```
            
            ### ğŸ“ Changes
            See [CHANGELOG.md](CHANGELOG.md) for detailed changes.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ğŸ“Š æ„å»ºæ€»ç»“
  build-summary:
    name: ğŸ“Š Build Summary
    needs: [build-executable, build-package]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Build Status
        run: |
          echo "## ğŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Executable Build | ${{ needs.build-executable.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Build | ${{ needs.build-package.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build-executable.result }}" == "success" && "${{ needs.build-package.result }}" == "success" ]]; then
            echo "ğŸ‰ All builds completed successfully!"
          else
            echo "âŒ Some builds failed. Check the logs above."
            exit 1
          fi
