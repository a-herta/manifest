name: ğŸ”’ Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scan daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ğŸ” ä»£ç å®‰å…¨æ‰«æ
  code-security:
    name: ğŸ” Code Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: ğŸ“¦ Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] safety semgrep

      - name: ğŸ”’ Run Bandit security scan
        run: |
          echo "ğŸ” Running Bandit security analysis..."
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f txt -o bandit-report.txt || true
          
          echo "ğŸ“Š Bandit scan completed"
          if [ -f bandit-report.txt ]; then
            echo "### ğŸ”’ Bandit Security Report" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -50 bandit-report.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ›¡ï¸ Run Safety dependency check
        run: |
          echo "ğŸ” Running Safety dependency scan..."
          safety check --json --output safety-report.json || true
          safety check --output safety-report.txt || true
          
          echo "ğŸ“Š Safety scan completed"
          if [ -f safety-report.txt ]; then
            echo "### ğŸ›¡ï¸ Safety Dependency Report" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat safety-report.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ” Run Semgrep SAST scan
        id: semgrep
        run: |
          echo "ğŸ” Running Semgrep SAST analysis..."
          semgrep --config=auto src/ --json --output=semgrep-report.json || true
          semgrep --config=auto src/ --output=semgrep-report.txt || true
          
          echo "ğŸ“Š Semgrep scan completed"
          if [ -f semgrep-report.txt ]; then
            echo "### ğŸ” Semgrep SAST Report" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -50 semgrep-report.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“Š Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_number }}
          path: |
            *-report.json
            *-report.txt
          retention-days: 30

  # ğŸ” ä¾èµ–æ¼æ´æ‰«æ
  dependency-scan:
    name: ğŸ” Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-audit

      - name: ğŸ” Run pip-audit
        run: |
          echo "ğŸ” Running pip-audit vulnerability scan..."
          pip-audit --format=json --output=pip-audit-report.json || true
          pip-audit --format=cyclonedx --output=pip-audit-sbom.json || true
          pip-audit || true

      - name: ğŸ“Š Upload dependency scan results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-${{ github.run_number }}
          path: |
            pip-audit-report.json
            pip-audit-sbom.json

  # ğŸ”§ é…ç½®å®‰å…¨æ£€æŸ¥
  config-security:
    name: ğŸ”§ Configuration Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check for secrets in code
        run: |
          echo "ğŸ” Scanning for potential secrets..."
          
          # Check for common secret patterns
          echo "### ğŸ” Secret Scan Results" >> $GITHUB_STEP_SUMMARY
          
          # API keys
          if grep -r -i "api[_-]key\|apikey" --include="*.py" --include="*.yml" --include="*.yaml" src/ .github/ || true; then
            echo "âš ï¸ Found potential API key references" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Tokens
          if grep -r -i "token\|secret" --include="*.py" --include="*.yml" --include="*.yaml" src/ .github/ || true; then
            echo "âš ï¸ Found potential token/secret references" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Passwords
          if grep -r -i "password\|passwd" --include="*.py" --include="*.yml" --include="*.yaml" src/ .github/ || true; then
            echo "âš ï¸ Found potential password references" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "âœ… Secret scan completed" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”§ Check file permissions
        run: |
          echo "ğŸ” Checking file permissions..."
          find . -type f -perm /111 -name "*.py" | head -10 || true
          echo "âœ… Permission check completed"

      - name: ğŸ”’ Check for hardcoded IPs/URLs
        run: |
          echo "ğŸ” Scanning for hardcoded IPs and URLs..."
          grep -r -E "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" --include="*.py" src/ || true
          echo "âœ… IP/URL scan completed"

  # ğŸ“‹ ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
  security-report:
    name: ğŸ“‹ Security Report Summary
    needs: [code-security, dependency-scan, config-security]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¥ Download security artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-results/

      - name: ğŸ“‹ Generate security summary
        run: |
          echo "## ğŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| Security Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Security | ${{ needs.code-security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Config Security | ${{ needs.config-security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Scan Results" >> $GITHUB_STEP_SUMMARY
          
          # Count total files scanned
          TOTAL_PY_FILES=$(find . -name "*.py" | wc -l)
          echo "- **Python files scanned:** $TOTAL_PY_FILES" >> $GITHUB_STEP_SUMMARY
          
          # Check if any reports exist
          if [ -d "security-results" ]; then
            echo "- **Security reports generated:** $(find security-results/ -name "*.json" | wc -l)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review security reports in the workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Address any high-severity findings" >> $GITHUB_STEP_SUMMARY
          echo "3. Update dependencies if vulnerabilities are found" >> $GITHUB_STEP_SUMMARY
          echo "4. Consider adding security checks to pre-commit hooks" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ğŸ”’ Security Scan Results
            
            | Check | Status |
            |-------|--------|
            | Code Security | ${{ needs.code-security.result == 'success' ? 'âœ… Passed' : 'âŒ Failed' }} |
            | Dependency Scan | ${{ needs.dependency-scan.result == 'success' ? 'âœ… Passed' : 'âŒ Failed' }} |
            | Config Security | ${{ needs.config-security.result == 'success' ? 'âœ… Passed' : 'âŒ Failed' }} |
            
            ğŸ“Š **Scan completed on:** ${new Date().toISOString()}
            
            Please review the security reports in the workflow artifacts if any issues were found.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });